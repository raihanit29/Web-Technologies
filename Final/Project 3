<?php
// ================================================
// Database Connection
// ================================================
$conn = new mysqli("localhost", "root", "", "cloth");
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}
$conn->set_charset("utf8mb4");

// ================================================
// Logic: Handle Product Rejection (Delete)
// ================================================
if (isset($_POST['reject_product'])) {
    $product_id = intval($_POST['product_id']);

    $sql_delete = "DELETE FROM product WHERE Product_Id = ?";
    $stmt = $conn->prepare($sql_delete);
    $stmt->bind_param("i", $product_id);

    if ($stmt->execute()) {
        // Redirect with a success flag in the URL
        header("Location: " . $_SERVER['PHP_SELF'] . "?status=deleted");
        exit;
    } else {
        echo "<script>alert('Error deleting product!');</script>";
    }
}

// ================================================
// Data Queries
// ================================================
$sql_orders = "SELECT * FROM `order` ORDER BY `Order_Id` DESC LIMIT 5";
$result_orders = $conn->query($sql_orders);

$sql_products = "SELECT * FROM `product` ORDER BY `Product_Id` DESC LIMIT 5";
$result_products = $conn->query($sql_products);

$sql_reviews = "SELECT * FROM `review` ORDER BY `Date` DESC LIMIT 5";
$result_reviews = $conn->query($sql_reviews);
?>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moderator Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
    }
    .container { display: flex; min-height: 100vh; }
    .sidebar {
      width: 250px;
      background-color: #f8f9fa;
      padding: 20px;
      border-right: 1px solid #ddd;
    }
    .sidebar .logo {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 50px;
      color: #666;
      text-align: center;
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .sidebar ul li {
      padding: 12px 0;
      font-size: 16px;
    }
    .sidebar ul li a {
      text-decoration: none;
      color: #555;
    }
    .sidebar ul li a:hover { color: #007bff; }
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #ccc;
    }
    .main-content { flex: 1; padding: 20px; }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      flex: 1;
      text-align: center;
    }
    .stat-card h3 { margin: 0; font-size: 24px; }
    .stat-card p { margin: 5px 0 0; color: #666; }
    .section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .section h2 {
      margin-top: 0;
      font-size: 18px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th { background-color: #f1f1f1; }
    .status {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .pending   { background: #fff3cd; color: #856404; }
    .shipped   { background: #d4edda; color: #155724; }
    .delivered { background: #d1ecf1; color: #0c5460; }
    .cancelled { background: #f8d7da; color: #721c24; }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      margin-right: 4px;
    }
    .btn-view    { background: #e9ecef; color: #495057; }
    .btn-approve { background: #28a745; color: white; }
    .btn-reject  { background: #dc3545; color: white; }
    .btn-delete  { background: #6c757d; color: white; }

    .action-buttons {
      white-space: nowrap;
    }

    .footer {
      text-align: center;
      padding: 20px;
      color: #888;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div class="container">

  <aside class="sidebar">
    <div class="logo">Logo</div>
    <div class="user-info">
      <img src="" alt="Moderator">
      <div>
        <strong>Moderator</strong><br>
        <small>moderator@commerce.com</small>
      </div>
    </div>
    <ul>
      <li><a href="#">Orders</a></li>
      <li><a href="#">Messages</a></li>
      <li><a href="#">Product Approvals</a></li>
    </ul>
  </aside>

  <div class="main-content">

    <header>
      <h1>Dashboard</h1>
      <div>
        <input type="text" placeholder="Search..." style="padding:8px; width:200px; border-radius:4px; border:1px solid #ccc;">
      </div>
    </header>

    <div class="stats">
      <div class="stat-card">
        <h3>234</h3>
        <p>Total Orders</p>
      </div>
      <div class="stat-card">
        <h3>15 orders</h3>
        <p>Pending</p>
      </div>
      <div class="stat-card">
        <h3>3</h3>
        <p>Products</p>
      </div>
    </div>

    <div class="section">
      <h2>Recent Orders <span style="float:right; font-weight:normal;"><a href="#">View All</a></span></h2>
      <table>
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Date</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <?php
          if ($result_orders && $result_orders->num_rows > 0) {
              while ($row = $result_orders->fetch_assoc()) {
                  $status_raw = $row['Status'] ?? 'Pending';
                  $status = strtolower(trim($status_raw));
                  $status_class = 'pending';
                  $display_status = ucfirst($status);

                  if (strpos($status, 'ship') !== false) $status_class = 'shipped';
                  elseif (strpos($status, 'deliv') !== false) $status_class = 'delivered';
                  elseif (strpos($status, 'cancel') !== false) $status_class = 'cancelled';

                  $order_id = $row['Order_Id'] ?? '—';
                  $date      = $row['Date']     ?? '—';

                  echo "<tr>";
                  echo "<td>#" . htmlspecialchars($order_id) . "</td>";
                  echo "<td>" . htmlspecialchars($date) . "</td>";
                  echo "<td><span class=\"status $status_class\">" . htmlspecialchars($display_status) . "</span></td>";
                  echo "<td><button class=\"btn btn-view\">View</button></td>";
                  echo "</tr>";
              }
          } else {
              echo '<tr><td colspan="4" style="text-align:center; padding:40px 0; color:#777;">No orders found</td></tr>';
          }
          ?>
        </tbody>
      </table>
    </div>

    <div class="section">
      <h2>Product Approvals <span style="float:right; font-weight:normal;"><a href="#">View All</a></span></h2>
      <table>
        <thead>
          <tr>
            <th>Product Id</th>
            <th>Product Name</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <?php
          if ($result_products && $result_products->num_rows > 0) {
              while ($row = $result_products->fetch_assoc()) {
                  $id   = $row['Product_Id'];
                  $name = $row['Product_Name'];
                  $date = $row['Date'];

                  echo "<tr>";
                  echo "<td>" . htmlspecialchars($id) . "</td>";
                  echo "<td>" . htmlspecialchars($name) . "</td>";
                  echo "<td>" . htmlspecialchars($date) . "</td>";
                  echo "<td class='action-buttons'>
                          <button class='btn btn-approve'>Approve</button>
                          <form method='POST' style='display:inline'>
                              <input type='hidden' name='product_id' value='$id'>
                              <button type='submit' class='btn btn-reject' 
                                  name='reject_product' 
                                  onclick=\"return confirm('Are you sure you want to reject this product?')\">
                                  Reject
                              </button>
                          </form>
                        </td>";
                  echo "</tr>";
              }
          } else {
              echo '<tr><td colspan="4" style="text-align:center; padding:40px 0; color:#777;">No products found</td></tr>';
          }
          ?>
        </tbody>
      </table>
    </div>

    <div class="section">
      <h2>Latest Messages/Reviews <span style="float:right; font-weight:normal;"><a href="#">View All</a></span></h2>
      <table>
        <thead>
          <tr>
            <th>From</th>
            <th>Date</th>
            <th>Message</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <?php
          if ($result_reviews && $result_reviews->num_rows > 0) {
              while ($row = $result_reviews->fetch_assoc()) {
                  $from    = $row['From']    ?? '—';
                  $date    = $row['Date']    ?? '—';
                  $message = $row['Message'] ?? '—';

                  echo "<tr>";
                  echo "<td>" . htmlspecialchars($from) . "</td>";
                  echo "<td>" . htmlspecialchars($date) . "</td>";
                  echo "<td>" . htmlspecialchars(substr($message, 0, 40)) . (strlen($message)>40?'...':'') . "</td>";
                  echo "<td class=\"action-buttons\">";
                  echo "<button class=\"btn btn-approve\">Approve</button>";
                  echo "<button class=\"btn btn-delete\">Delete</button>";
                  echo "</td>";
                  echo "</tr>";
              }
          } else {
              echo '<tr><td colspan="4" style="text-align:center; padding:40px 0; color:#777;">No messages/reviews yet</td></tr>';
          }
          ?>
        </tbody>
      </table>
    </div>

    <div class="footer">
       My eCommerce © 2026
    </div>

  </div>
</div>

<script>
    // Check if the URL contains "status=deleted"
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('status') === 'deleted') {
        alert('Delete Successful');
        
        // Optional: Clean the URL so the message doesn't pop up again on refresh
        window.history.replaceState({}, document.title, window.location.pathname);
    }
</script>

<?php
$conn->close();
?>

</body>
</html>
